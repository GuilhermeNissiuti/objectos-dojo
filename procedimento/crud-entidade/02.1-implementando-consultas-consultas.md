---
layout: post-alpha
title: "Implementando Consultas: Consultas"
author: "Tiago Aguiar"
user: "taguiar"
date: "2012-03-14"
published: true
partof: procedimento-crud-entidade
num: 6
outof: 6
---

## <a id="TOPO"> </a> Introdução
Para realizarmos uma consulta em um banco de dados, precisamos que o JAVA seje capaz de interpretar
a linguagem SQL contida em seus métodos. Há classes específicas que nos permite escrever códigos
desta forma (SQL dentro do JAVA). 

## Antes de iniciar 
Este item exige conhecimentos sobre:

- Interface
- Linguagem SQL

## Implementação
Conforme o artigo anterior, as consultas precisam ser criadas para que o teste realmente funcione. 

Siga o checklist abaixo:
<table class="table table-bordered">
 <tr>
   <td class="tac col2em">
    <a id="topo_0_0"><input type="checkbox" /></a>
   </td>
   <td>
	<a href="#0_0">Implementar a interface: ConsultaDeLivroDTO</a>  
   </td>
 </tr>
  <tr>
   <td class="tac col2em">
    <a id="topo_0_1"><input type="checkbox" /></a>
   </td>
   <td>
    <a href="#0_1">Implementar a classe: ConsultaDeLivro</a>
   </td>
 </tr>
</table>

### <a id="0_0"> </a>Implementar a interface: ConsultaDeLivroDTO
Agora o processo de implementação se torna mais prático utilizando TDD.<br>
Na classe `TesteDeConsultaDeLivro`, precisamos apenas de um `Ctrl + 1` na linha que contenha
`ConsultaDeLivroDTO`.

	private class ToTitulo implements Function<ConsultaDeLivroDTO, String> {
	
Crie a interface no pacote `br.com.objectos.dojo.biblioteca.ui.api` do diretório `/src/main/java/`.	
	
Execute o mesmo procedimento nos retornos dos métodos em `TesteDeConsultaDeLivro`.

	return input.getTitulo();
	
	return input.getLocalizacao();
	
	return input.getAutorPrincipal();
	  
	return input.getPublicacao();
	
Nota: Em `ConsultaDeLivroDTO` defina os retornos como tipo primitivo.

A interface `ConsultaDeLivroDTO` deve ter esta estrutura.

	public interface ConsultaDeLivroDTO {
	
	  String getTitulo();
	  
	  int getLocalizacao();
	
	  String getAutorPrincipal();
	
	  LocalDate getPublicacao();
	
	}

### <a id="0_1"> </a>Implementar a classe: ConsultaDeLivro
O processo é o mesmo descrito na implementação da interface: `Ctrl + 1` na linha que contenha
`ConsultaDeLivro` e `consulta.list(wrapper)`. 

	@Inject
	private ConsultaDeLivro consulta;

<br>

	List<ConsultaDeLivroDTO> res = consulta.list(wrapper);
	
Tendo a classe e a interface podemos escrever o código que realiza a consulta dos livros.
Utilize a interface `Provider` do pacote `com.google.inject` junto a interface `NativeSql` do pacote
`br.com.objectos.comuns.relational.jdbc`.
	
	
	private final Provider<NativeSql> sqlProvider;

  	@Inject
  	public ConsultaDeLivro(Provider<NativeSql> sqlProvider) {
      this.sqlProvider = sqlProvider;
  	}
	
	public List<ConsultaDeLivroDTO> list(RequestWrapper wrapper) {
	  Page page = wrapper.getPage();
	  Integer localizacao = wrapper.param("localizacao");
	  
	  return sqlProvider.get()
	      
	      .add("select *")
	      
	      .add("from BIBLIOTECA.LIVRO as LIVRO")
	      
	      .add("where 1 = 1")
	      .addIf("and LIVRO.LOCALIZACAO = ?").paramNotNull(localizacao)
	      
	      .add("order by")
	      .add("LIVRO.TITULO")
	      
	      .andLoadWith(new DTOLoader())
	      
	      .listPage(page);
	}
	
A linha `.addIf("and LIVRO.LOCALIZACAO = ?").paramNotNull(localizacao)` será executada somente se
o valor de `localizacao` não for nulo, ou seja, somente quando o método de teste de filtro for executado.	
	
Nota: A sintaxe SQL é descrita em forma de String.

Crie a classe privada `DTOLoader`. Esta classe possui um método que instancia um `Loader` já 
com os dados populados em um objeto `ConsultaDeLivroDTO` retornando-o no fim da execução do método
`novaInstancia()`.	
	
	private class DTOLoader implements ResultSetLoader<ConsultaDeLivroDTO> {
	  @Override
	  public ConsultaDeLivroDTO load(ResultSet resultSet) throws SQLException {
	    ResultSetWrapper rs = new ResultSetWrapper(resultSet);
	    return new Loader(rs).novaInstancia();
	  }
	}
	
É no `Loader` onde definimos as colunas que serão consultadas através do `ResultSetWrapper` e o 
também o método `novaInstancia()` do `Construtor` para criar um objeto com os valores da consulta. 
Lembrando que é necessário apenas escrever o nome da coluna e/ou banco de dados na forma de String.	
	
	private class Loader implements ConsultaDeLivroDTO, Construtor<ConsultaDeLivroDTO> {
	
	  private final ResultSetWrapper rs;
	
	  public Loader(ResultSetWrapper rs) {
	    this.rs = rs;
	  }
	    
	  @Override
	  public ConsultaDeLivroDTO novaInstancia() {
	    return new DTO(this);
	  }
	
	  @Override
	  public String getTitulo() {
	    return rs.getString("TITULO");
	  }
	    
	  @Override
	  public int getLocalizacao() {
	    return rs.getInt("LOCALIZACAO");
	  }
	    
	  @Override
	  public String getAutorPrincipal() {
	    return rs.getString("AUTO_PRINCIPAL");
	  }
	    
	  @Override
	  public LocalDate getPublicacao() {
	    return rs.getLocalDate("PUBLICACAO");
	  }
	    
	}
	
E para finalizar, crie uma classe privada `DTO`. Esta classe é um construtor que atribue os valores
obtidos em cada resultSet da classe anterior à uma variável de instância. Só assim o objeto 
`ConsultaDeLivroDTO` poderá ser instanciado com os valores desejados para o teste.

    private class DTO implements ConsultaDeLivroDTO {

      private final String titulo;
      private final int localizacao;
      private final String autoPrincipal;
      private final LocalDate publicacao;

      public DTO(ConsultaDeLivroDTO construtor) {
        this.titulo = construtor.getTitulo();
        this.locaizacao = construtor.getLocalizacao();
        this.autoPrincipal = construtor.getAutorPrincipal();
        this.publicacao = construtor.getPublicacao();
      }
    
      @Override
      public String getTitulo() {
        return titulo;
      }
    
      @Override
	  public int getLocalizacao() {
        return localizacao;
	  }
	    
	  @Override
	  public String getAutorPrincipal() {
	    return autoPrincipal;
	  }
	    
	  @Override
	  public LocalDate getPublicacao() {
	    return publicacao;
	  }
    
    }
    
Execute o teste na classe `TesteDeConsultaDeLivro` e verifique os resultados obtidos!     				

Para mais informações acesse os códigos nos links abaixo:

[ConsultaDeLivro.java](https://github.com/objectos/objectos-dojo/tree/master/objectos-dojo-team/src/main/java/br/com/objectos/dojo/taguiar/ConsultaDeLivro.java)<br>
[ConsultaDeLivroDTO.java](https://github.com/objectos/objectos-dojo/tree/master/objectos-dojo-team/src/main/java/br/com/objectos/dojo/taguiar/ConsultaDeLivroDTO.java)<br>

Retornar aos Procedimentos! <a href="{{ site.baseurl }}/procedimento/" class="btn btn-success">Voltar!</a><br>
Leia mais uma vez! <a href="#TOPO" class="btn btn-warning">Revisar!</a>